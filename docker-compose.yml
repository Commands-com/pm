version: '3.8'

services:
  project-manager:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    
    ports:
      - "8080:8080"  # Main API and dashboard
      - "8081:8081"  # MCP Server-Sent Events endpoint
    
    volumes:
      # Persistent data volume for database and logs
      - project_data:/app/data
      # Mount examples as read-only for demonstration
      - ./examples:/app/examples:ro
    
    environment:
      # Database configuration
      - DATABASE_PATH=/app/data/tasks.db
      
      # Logging configuration
      - LOG_LEVEL=INFO
      - LOG_FORMAT=json
      - LOG_FILE=/app/data/project_manager.log
      
      # Server configuration
      - DEFAULT_PORT=8080
      - MCP_PORT=8081
      - HOST=0.0.0.0
      
      # MCP protocol configuration
      - MCP_TRANSPORT=sse
      - MCP_MAX_CONNECTIONS=50
      
      # WebSocket configuration
      - WEBSOCKET_PING_INTERVAL=20
      - WEBSOCKET_PING_TIMEOUT=10
      - WEBSOCKET_MAX_CONNECTIONS=100
      
      # Performance tuning
      - LOCK_CLEANUP_INTERVAL=300
      - DATABASE_POOL_SIZE=10
      - QUERY_TIMEOUT_SECONDS=30
      
      # Security
      - CORS_ORIGINS=*
      - CORS_ALLOW_CREDENTIALS=true
      
      # Monitoring
      - HEALTH_CHECK_TIMEOUT=5
      - METRICS_ENABLED=true
      - PERFORMANCE_MONITORING=true
      
      # Application metadata
      - VERSION=1.0.0
      - ENVIRONMENT=production
    
    healthcheck:
      test: ["CMD", "python", "/app/docker-healthcheck.py"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    
    restart: unless-stopped
    
    # Security and resource constraints
    security_opt:
      - no-new-privileges:true
    
    # Resource limits for production deployment
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

volumes:
  project_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data

networks:
  default:
    name: project-manager-network